<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Fix Playground</title>
</head>

<body>
    <div style="height: 99%; display: flex; flex-direction: column;">
        <div id="header" class="header-bar">
            <div class="header-content">
                <span id="title" class="header-item"
                    style="margin-top: 0px; margin-bottom: 0px; margin-right: 10px; margin-left: 0px; font-family: 'Yu Gothic', 'Meiryo', 'MS PGothic', 'Noto Sans JP', 'Noto Sans', Arial, Helvetica, sans-serif;">
                    Fix Playground</span>
            </div>
            <div class="header-content">
                <a class="header-item" href="https://github.com/tttmmmyyyy/fixlang?tab=readme-ov-file#documents"
                    target="_blank" rel="noopener noreferrer">Documents</a>
            </div>
            <div class="header-content">
                <a class="header-item" href="https://github.com/tttmmmyyyy/fixlang#examples" target="_blank"
                    rel="noopener noreferrer">Examples</a>
            </div>
        </div>
        <div id="button-bar" class="button-bar">
            <a href="#" id="run-btn" class="header-item" onclick="run()">Run</a>
            <a href="#" id="share-btn" class="header-item" onclick="share()">Share</a>
        </div>
        <div id="editor-area" style="flex-grow: 1; border: 1px; display: flex">
            <div id="editor" style="height: 100%; width: 100%; display: inline-block"></div>
        </div>
        <div id="output-area" style="width: 100%; display: flex; min-height: 200px;">
            <div class="io-panel">
                <div class="io-header">Input</div>
                <textarea id="input" rows="8" placeholder="Standard input..."
                    style="height: calc(100% - 25px); width: 100%; box-sizing: border-box; padding: 3px; background-color: #2d2d30; color: #d4d4d4; border: 1px solid #666; resize: none;"></textarea>
            </div>
            <div class="io-panel">
                <div class="io-header">Output</div>
                <textarea id="output" readonly rows="8"
                    style="height: calc(100% - 25px); width: 100%; box-sizing: border-box; padding: 3px; background-color: #2d2d30; color: #d4d4d4; border: 1px solid #666; resize: none;"></textarea>
            </div>
            <div class="io-panel">
                <div class="io-header">Error</div>
                <textarea id="error" readonly rows="8"
                    style="height: calc(100% - 25px); width: 100%; box-sizing: border-box; padding: 3px; background-color: #2d2d30; color: #ff9999; border: 1px solid #666; resize: none;"></textarea>
            </div>
        </div>
    </div>
</body>

<style>
    .header-bar {
        min-height: 48px;
        margin: 5px 10px 5px 10px;
        box-sizing: border-box;
        display: flex;
        align-items: baseline;
    }

    .button-bar {
        margin: 0px 10px 5px 10px;
        display: flex;
        align-items: center;
        padding: 0;
    }

    .button-bar .header-item:not(:last-child) {
        margin-right: 20px;
    }

    .header-item {
        font-size: 1em;
        font-family: 'Yu Gothic', 'Meiryo', 'MS PGothic', 'Noto Sans JP', 'Noto Sans', Arial, Helvetica, sans-serif;
        font-weight: bold;
        vertical-align: middle;
        color: #d4d4d4;
        text-decoration: none;
    }

    .header-item:visited,
    .header-item:active,
    .header-item:hover {
        text-decoration: none;
        color: #d4d4d4;
    }

    #title.header-item {
        font-size: 1.8em;
        font-weight: bold;
        color: #d4d4d4;
    }
</style>

<style type="text/css">
    .header-content {
        display: flex;
        align-items: baseline;
        margin-right: 10px;
        margin-left: 0px;
    }

    .io-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #666;
        min-width: 200px;
    }

    .io-panel:last-child {
        border-right: none;
    }

    .io-header {
        background-color: #3c3c3c;
        color: #d4d4d4;
        padding: 4px 8px;
        font-weight: bold;
        font-size: 0.9em;
        border-bottom: 1px solid #666;
        user-select: none;
    }



    html,
    body {
        height: 100%;
        margin: 0;
        background-color: #2d2d30;
        color: #d4d4d4;
    }
</style>

<script src="./src-noconflict/ace.js"></script>
<script>
    // a functon to get parameter
    function getParam(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    // set up editor
    var editor = ace.edit("editor", {
        theme: "ace/theme/tomorrow_night",
        mode: "ace/mode/fixlang",
        minLines: 2
    });
    editor.setOption("wrap", true);
    editor.setOption("fontSize", "16px");

    // set initial source code
    var source_param = getParam("src");  // url encoded source
    var source_param2 = getParam("src2"); // base64 encoded source
    if (source_param2 !== null) {
        if (source_param2.trim()) {
            const decoded_utf8str = atob(source_param2);
            const decoded_array = new Uint8Array(Array.prototype.map.call(decoded_utf8str, c => c.charCodeAt()));
            const decoded = new TextDecoder().decode(decoded_array);
            editor.setValue(decoded);
        } else {
            editor.setValue('');
        }
    } else if (source_param !== null) {
        if (source_param.trim()) {
            editor.setValue(source_param);
        } else {
            editor.setValue('');
        }
    } else {
        editor.setValue(`module Main;

main : IO () = (
    "Hello World!".println
);
`);
    }

    // handler for run button
    function run() {
        var source = editor.getValue();
        var output = document.getElementById('output');
        output.value = "Running...";

        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://run-fix-36eqzptjpa-an.a.run.app');
        // xhr.open('POST', 'http://localhost:8080');
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
                if (xhr.status == 200) {
                    output.value = xhr.responseText;
                } else {
                    output.value = "server error (code: " + xhr.status + ")"
                }
            }
        }
        xhr.send(source);
    }

    // handler for share button
    function share() {
        var source = editor.getValue();
        let utf8str = String.fromCharCode.apply(null, new TextEncoder().encode(source));
        const encoded = btoa(utf8str);
        const url = location.protocol + '//' + location.host + location.pathname + "?src2=" + encodeURIComponent(encoded);
        navigator.clipboard.writeText(url).then(function () {
            var share_btn = document.getElementById("share-btn");
            share_btn.innerText = "Copied!";
            window.setTimeout(function () {
                share_btn.innerText = "Copy link";
            }, 1500);
        })
    }
</script>