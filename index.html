<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Fix Playground</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>

<body>
    <div style="height: 99%; display: flex; flex-direction: column;">
        <div id="header" class="header-bar">
            <div class="header-content">
                <span id="title" class="header-item"
                    style="margin-top: 0px; margin-bottom: 0px; margin-right: 10px; margin-left: 0px; font-family: 'Yu Gothic', 'Meiryo', 'MS PGothic', 'Noto Sans JP', 'Noto Sans', Arial, Helvetica, sans-serif;">
                    Fix Playground</span>
            </div>
            <div class="header-content">
                <a class="header-item" href="https://github.com/tttmmmyyyy/fixlang?tab=readme-ov-file#documents"
                    target="_blank" rel="noopener noreferrer">Documents</a>
            </div>
            <div class="header-content">
                <a class="header-item" href="https://github.com/tttmmmyyyy/fixlang#examples" target="_blank"
                    rel="noopener noreferrer">Examples</a>
            </div>
        </div>
        <div id="button-bar" class="button-bar">
            <!-- Group 1: Run, Share -->
            <a href="#" id="run-btn" class="header-item button-group-1" onclick="run()"><span
                    class="material-symbols-outlined">play_arrow</span></a>
            <a href="#" id="share-btn" class="header-item button-group-1" onclick="share()"><span
                    class="material-symbols-outlined">link</span></a>

            <!-- Group 2: Undo, Redo -->
            <a href="#" id="undo-btn" class="header-item button-group-2" onclick="undoCode()"><span
                    class="material-symbols-outlined">undo</span></a>
            <a href="#" id="redo-btn" class="header-item button-group-2" onclick="redoCode()"><span
                    class="material-symbols-outlined">redo</span></a>

            <!-- Group 3: Cut, Copy, Copy All, Paste, Clear -->
            <a href="#" id="cut-btn" class="header-item button-group-3" onclick="cutCode()"><span
                    class="material-symbols-outlined">content_cut</span></a>
            <a href="#" id="copy-btn" class="header-item button-group-3" onclick="copyCode()"><span
                    class="material-symbols-outlined">content_copy</span></a>
            <a href="#" id="copy-all-btn" class="header-item button-group-3" onclick="copyAll()"><span
                    class="material-symbols-outlined">copy_all</span></a>
            <a href="#" id="paste-btn" class="header-item button-group-3" onclick="pasteCode()"><span
                    class="material-symbols-outlined">content_paste</span></a>
            <a href="#" id="clear-btn" class="header-item button-group-3" onclick="clearCode()"><span
                    class="material-symbols-outlined">delete</span></a>
        </div>
        <div id="editor-area" style="flex-grow: 1; border: 1px; display: flex">
            <div id="editor" style="height: 100%; width: 100%; display: inline-block"></div>
        </div>
        <div id="output-area" style="width: 100%; display: flex; min-height: 200px;">
            <div class="io-panel">
                <div class="io-header">
                    <span>Input</span>
                    <div class="io-buttons">
                        <a href="#" class="io-button" onclick="pasteToInput()">
                            <span class="material-symbols-outlined">content_paste</span>
                        </a>
                        <a href="#" class="io-button" onclick="clearInput()">
                            <span class="material-symbols-outlined">delete</span>
                        </a>
                    </div>
                </div>
                <textarea id="input" rows="8"
                    style="height: calc(100% - 32px); width: 100%; box-sizing: border-box; padding: 3px; background-color: #25282C; color: #d4d4d4; border: none; border-radius: 0; resize: none;"></textarea>
            </div>
            <div class="io-panel">
                <div class="io-header">
                    <span>Output</span>
                    <div class="io-buttons">
                        <a href="#" class="io-button" onclick="copyOutput()">
                            <span class="material-symbols-outlined">content_copy</span>
                        </a>
                    </div>
                </div>
                <textarea id="output" readonly rows="8"
                    style="height: calc(100% - 32px); width: 100%; box-sizing: border-box; padding: 3px; background-color: #25282C; color: #d4d4d4; border: none; border-radius: 0; resize: none;"></textarea>
            </div>
            <div class="io-panel">
                <div class="io-header">
                    <span>Error</span>
                    <div class="io-buttons">
                        <a href="#" class="io-button" onclick="copyError()">
                            <span class="material-symbols-outlined">content_copy</span>
                        </a>
                    </div>
                </div>
                <textarea id="error" readonly rows="8"
                    style="height: calc(100% - 32px); width: 100%; box-sizing: border-box; padding: 3px; background-color: #25282C; color: #ff9999; border: none; border-radius: 0; resize: none;"></textarea>
            </div>
        </div>
    </div>
</body>

<style>
    .header-bar {
        min-height: 48px;
        margin: 5px 10px 5px 10px;
        box-sizing: border-box;
        display: flex;
        align-items: baseline;
    }

    .button-bar {
        margin: 0px 10px 5px 10px;
        display: flex;
        align-items: center;
        padding: 0;
    }

    /* Default button spacing */
    .button-bar .header-item {
        margin-right: 5px;
    }

    /* Group separators with vertical lines */
    #share-btn {
        margin-right: 25px;
        position: relative;
    }

    #share-btn::after {
        content: '';
        position: absolute;
        right: -12px;
        top: 20%;
        bottom: 20%;
        width: 1px;
        background-color: #666;
    }

    #redo-btn {
        margin-right: 25px;
        position: relative;
    }

    #redo-btn::after {
        content: '';
        position: absolute;
        right: -12px;
        top: 20%;
        bottom: 20%;
        width: 1px;
        background-color: #666;
    }

    .header-item {
        font-size: 1em;
        font-family: 'Yu Gothic', 'Meiryo', 'MS PGothic', 'Noto Sans JP', 'Noto Sans', Arial, Helvetica, sans-serif;
        font-weight: bold;
        vertical-align: middle;
        color: #d4d4d4;
        text-decoration: none;
        padding: 4px 6px;
        border-radius: 3px;
        display: inline-flex;
        align-items: center;
        transition: background-color 0.2s;
    }

    .header-item:visited,
    .header-item:active {
        text-decoration: none;
        color: #d4d4d4;
    }

    .header-item:hover {
        text-decoration: none;
        color: #ffffff;
        background-color: #4a4a4a;
    }

    .material-symbols-outlined {
        font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24;
        vertical-align: middle;
    }

    #title.header-item {
        font-size: 1.8em;
        font-weight: bold;
        color: #d4d4d4;
    }

    #title.header-item:hover {
        background-color: transparent;
        color: #d4d4d4;
    }

    .header-content {
        display: flex;
        align-items: baseline;
        margin-right: 10px;
        margin-left: 0px;
    }

    .io-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #666;
        min-width: 200px;
    }

    .io-panel:last-child {
        border-right: none;
    }

    .io-header {
        background-color: #25282C;
        color: #d4d4d4;
        padding: 6px 8px;
        font-weight: bold;
        font-size: 1em;
        font-family: 'Yu Gothic', 'Meiryo', 'MS PGothic', 'Noto Sans JP', 'Noto Sans', Arial, Helvetica, sans-serif;
        border-bottom: 1px solid #666;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 32px;
    }

    .io-buttons {
        display: flex;
        gap: 5px;
    }

    .io-button {
        color: #d4d4d4;
        text-decoration: none;
        padding: 4px 6px;
        border-radius: 3px;
        display: flex;
        align-items: center;
        font-size: 24px;
        transition: background-color 0.2s;
    }

    .io-button:hover {
        background-color: #4a4a4a;
        color: #ffffff;
    }

    .io-button .material-symbols-outlined {
        font-size: 24px;
    }


    .io-panel textarea {
        scrollbar-width: none;
        /* Firefox */
        -ms-overflow-style: none;
        /* Internet Explorer 10+ */
        font-size: 16px;
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', 'Menlo', 'Consolas', monospace;
        font-weight: normal;
    }

    .io-panel textarea::-webkit-scrollbar {
        display: none;
        /* WebKit browsers (Chrome, Safari, newer versions of Edge) */
    }



    html,
    body {
        height: 100%;
        margin: 0;
        background-color: #25282C;
        color: #d4d4d4;
    }
</style>

<script src="./src-noconflict/ace.js"></script>
<script>
    // Configuration
    const API_URL = 'https://run-fix-36eqzptjpa-an.a.run.app';  // Production
    // const API_URL = 'http://localhost:8080';  // Development

    // a functon to get parameter
    function getParam(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    // set up editor
    var editor = ace.edit("editor", {
        theme: "ace/theme/tomorrow_night",
        mode: "ace/mode/fixlang",
        minLines: 2
    });
    editor.setOption("wrap", true);
    editor.setOption("fontSize", "16px");

    // set initial source code
    var source_param = getParam("src");  // url encoded source
    var source_param2 = getParam("src2"); // base64 encoded source
    if (source_param2 !== null) {
        if (source_param2.trim()) {
            const decoded_utf8str = atob(source_param2);
            const decoded_array = new Uint8Array(Array.prototype.map.call(decoded_utf8str, c => c.charCodeAt()));
            const decoded = new TextDecoder().decode(decoded_array);
            editor.setValue(decoded);
        } else {
            editor.setValue('');
        }
    } else if (source_param !== null) {
        if (source_param.trim()) {
            editor.setValue(source_param);
        } else {
            editor.setValue('');
        }
    } else {
        editor.setValue(`module Main;

main : IO () = (
    "Hello World!".println
);
`);
    }

    // handler for run button
    function run() {
        var source = editor.getValue();
        var stdin = document.getElementById('input').value;
        var output = document.getElementById('output');
        var error = document.getElementById('error');
        output.value = "Running...";
        error.value = "";

        var xhr = new XMLHttpRequest();
        xhr.open('POST', API_URL);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
                if (xhr.status == 200) {
                    try {
                        var response = JSON.parse(xhr.responseText);
                        output.value = response.output || "";
                        error.value = response.error || "";
                    } catch (e) {
                        output.value = "";
                        error.value = "Failed to parse server response: " + e.message;
                    }
                } else {
                    output.value = "";
                    error.value = "Server error (code: " + xhr.status + ")";
                }
            }
        }

        var requestData = {
            source: source,
            input: stdin
        };
        xhr.send(JSON.stringify(requestData));
    }

    // handler for share button
    function share() {
        var source = editor.getValue();
        let utf8str = String.fromCharCode.apply(null, new TextEncoder().encode(source));
        const encoded = btoa(utf8str);
        const url = location.protocol + '//' + location.host + location.pathname + "?src2=" + encodeURIComponent(encoded);
        navigator.clipboard.writeText(url);

        // Change icon to check temporarily
        const shareIcon = document.querySelector('#share-btn .material-symbols-outlined');
        const originalIcon = shareIcon.textContent;
        shareIcon.textContent = 'check';

        // Restore original icon after 2 seconds
        setTimeout(() => {
            shareIcon.textContent = originalIcon;
        }, 2000);
    }

    // handler for cut button
    function cutCode() {
        var selectedText = editor.getSelectedText();
        if (selectedText) {
            navigator.clipboard.writeText(selectedText);
            editor.session.replace(editor.getSelectionRange(), '');
        }
    }

    // handler for clear button
    function clearCode() {
        editor.setValue('');
        editor.clearSelection();
    }

    // handler for paste to input button
    function pasteToInput() {
        navigator.clipboard.readText().then(text => {
            document.getElementById('input').value = text;
        });
    }

    // handler for clear input button
    function clearInput() {
        document.getElementById('input').value = '';
    }

    // handler for copy output button
    function copyOutput() {
        var outputText = document.getElementById('output').value;
        if (outputText) {
            navigator.clipboard.writeText(outputText);
        }
    }

    // handler for copy error button
    function copyError() {
        var errorText = document.getElementById('error').value;
        if (errorText) {
            navigator.clipboard.writeText(errorText);
        }
    }

    // handler for copy button
    function copyCode() {
        var selectedText = editor.getSelectedText();
        if (selectedText) {
            navigator.clipboard.writeText(selectedText);
        }
    }

    // handler for copy all button
    function copyAll() {
        var source = editor.getValue();
        navigator.clipboard.writeText(source);
    }

    // handler for paste button
    function pasteCode() {
        navigator.clipboard.readText().then(text => {
            editor.insert(text);
        });
    }

    // handler for undo button
    function undoCode() {
        editor.undo();
    }

    // handler for redo button
    function redoCode() {
        editor.redo();
    }
</script>

</body>

</html>